{% extends 'base.html' %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static 'mainpage.css' %}">
  <title>Small Chart with Cards</title>

</head>
<style>
  /* Styles for "No Deadlines" Message */
.no-deadlines {
  text-align: center;
  margin-top: -150px;
  margin-left: 400px;
  color: #6c63ff; /* Green to indicate positivity */
  font-size: 1.5rem;
  font-weight: bold;
}

.no-deadlines-message {
  margin-bottom: 20px;
}

.no-deadlines-animation {
  display: flex;
  justify-content: center;
  align-items: center;
}

/* Character Animation */
.character {
  position: relative;
  display: inline-flex;
  align-items: center;
  animation: bounce 2s infinite;
}

.face {
  width: 100px;
  height: 100px;
  background: #ffeb3b;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.eyes {
  display: flex;
  gap: 10px;
}

.eye {
  width: 15px;
  height: 15px;
  background: #333;
  border-radius: 50%;
}

.mouth {
  position: absolute;
  bottom: 20px;
  width: 30px;
  height: 15px;
  background: #e57373;
  border-radius: 50%;
}

@keyframes bounce {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
}

.priority-task-container {
  position: absolute; /* Maintain absolute positioning */
    top: 310px; /* Adjust top value to align properly */
    left: 270px; /* Use `left` instead of `right` to align to the left */
    display: flex; /* Arrange cards horizontally */
    gap: 35px; /* Add spacing between cards */
    z-index: 1; /* Ensure it overlaps other content */
}
.task-card {
  background-color: #fff; /* White background for the card */
  border-radius: 10px; /* Rounded corners for smoother edges */
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Light shadow for depth */
  padding: 15px; /* Add internal padding for content */
  width: 390px; /* Set width to fit content */
  text-align: left; /* Align text to the left */
  position: relative; /* Enable child positioning */
  transition: transform 0.3s ease, box-shadow 0.3s ease; /* Smooth hover effects */
  }
</style>

<body>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>

  <div class="chart-title" id = "chart-title">Progress Overview</div>
  <div class="chart-container" id="chart-container">
    <canvas id="chart" width="350" height="350"></canvas>
  </div>

  <script>
    console.log('first')
    // Parse environmentStats safely
    const environmentStats = JSON.parse('{{ environment_stats|escapejs }}') || [];

    // Log parsed data for debugging
    console.log(environmentStats);

    // Extract labels and data dynamically
    const labels = environmentStats.map(stat => stat.environment_id__label || "No Environment");
    const progressData = environmentStats.map(stat => (stat.done_ratio * 100).toFixed(2)); // Convert to percentage

    // Check if the chart should be displayed
    if (environmentStats.length === 0 || (environmentStats.length > 0 && environmentStats[0]['done_tasks'] === 0)) {
      console.error("No data available for chart.");
      document.getElementById("chart-title").style.display = "none";
    } else {
      // Initialize chart if data is available
      let ctx = document.getElementById("chart").getContext("2d");
      let chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Progress %",
              backgroundColor: "#a18dfb",
              borderColor: "#e0e0e0",
              data: progressData
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: "y",
          plugins: {
            legend: { display: false }, // Hide legend
            tooltip: { enabled: true } // Enable/disable tooltips as desired
          },
          scales: {
            x: {
              grid: { display: false },
              display: false
            },
            y: {
              grid: { display: false },
              display: true
            }
          }
        }
      });
    }
  </script>



  <!-- Priority Task Section -->
  <div class="priority-task-container">
    {% for task_with_env in priority_tasks %}
    <div class="task-card">
      <div
        class="priority {% if task_with_env.task.priority == 'HIGH' %}high-priority{% elif task_with_env.task.priority == 'MID' %}medium-priority{% elif task_with_env.task.priority == 'LOW' %}low-priority{% endif %}">
        {% if task_with_env.task.priority == 'HIGH' %}
        High Priority
        {% elif task_with_env.task.priority == 'MID' %}
        Med Priority
        {% else %}
        Low Priority
        {% endif %}
      </div>
      <div class="task-title">{{ task_with_env.task.content }}</div> <br>
      <div class="upcoming-deadlines-info">on {{ task_with_env.environment_name }}</div>


      <div class="upcoming-deadlines-info">
        <p>Due: {{ task_with_env.task.deadline|date:"F j, Y" }}</p>
      </div>
    </div>
    {% endfor %}
  </div>


  <!-- Card section -->

  <div class="card-container">
    <!-- Card for To Do -->
    <div class="card todo">
      <div class="card-title">To Do</div>
      <div class="card-count">{{ task_counts.todo }}</div>
      <div class="card-total">/ {{ task_counts.total }}</div>
    </div>

    <!-- Card for In Progress -->
    <div class="card in-progress">
      <div class="card-title">In Progress</div>
      <div class="card-count">{{ task_counts.in_progress }}</div>
      <div class="card-total">/ {{ task_counts.total }}</div>
    </div>

    <!-- Card for Done -->
    <div class="card done">
      <div class="card-title">Done</div>
      <div class="card-count">{{ task_counts.done }}</div>
      <div class="card-total">/ {{ task_counts.total }}</div>
    </div>
  </div>



  <!-- Priority Task Section -->
   {% if tasks_with_environment %}
  <h3 class="upcoming-deadlines-header">Upcoming Deadlines</h3>
  {% endif %}


  <div class="upcoming-deadlines">
    {% for item in tasks_with_environment %}
    <div class="upcoming-deadlines-card">
      <!-- Task Title -->
      <div class="upcoming-deadlines-title">{{ item.task.content }}</div><br>

      <!-- Environment Name -->
      <div class="upcoming-deadlines-info">on {{ item.environment_name|default:"No Environment" }}</div>

      <!-- Deadline -->
      <div class="upcoming-deadlines-info">
        <p>Due: {{ item.task.deadline|date:"F j, Y" }}</p>
      </div>
    </div>
    {% empty %}
    <div class="no-deadlines">
      <div class="no-deadlines-message">
        ðŸŽ‰ Woohoo! No upcoming deadlines!
      </div>
      <div class="no-deadlines-animation">
        <div class="character">
          <div class="face">
            <div class="eyes">
              <div class="eye"></div>
              <div class="eye"></div>
            </div>
            <div class="mouth"></div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>



</body>

</html>

{% endblock %}